<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Big Al">
<title>Big Al</title>
<link rel="manifest" href="manifest.json">
<style>
  @import url('https://fonts.googleapis.com/css2?family=DM+Sans:opsz,wght@9..40,400;9..40,600;9..40,700;9..40,800&display=swap');

  :root {
    --bg-primary: #0f1724;
    --bg-secondary: #1a2538;
    --bg-tile: #1e2d44;
    --bg-tile-hover: #263a54;
    --bg-tile-active: #2f4666;
    --accent-gold: #f0a830;
    --accent-gold-dim: #c4892a;
    --accent-red: #e74c4c;
    --accent-red-bg: #3d1c1c;
    --accent-green: #4ade80;
    --accent-green-bg: #1a3d2a;
    --text-primary: #f0f0f0;
    --text-secondary: #8aa0bc;
    --text-dim: #5a7089;
    --border-subtle: rgba(255,255,255,0.06);
    --shadow-tile: 0 2px 8px rgba(0,0,0,0.3);
    --shadow-tile-active: 0 1px 3px rgba(0,0,0,0.4);
    --radius: 16px;
    --tile-gap: 12px;
  }

  * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
    -webkit-tap-highlight-color: transparent;
    -webkit-touch-callout: none;
    -webkit-user-select: none;
    user-select: none;
  }

  html, body {
    height: 100%;
    overflow: hidden;
    background: var(--bg-primary);
    color: var(--text-primary);
    font-family: 'DM Sans', -apple-system, sans-serif;
  }

  body {
    display: flex;
    flex-direction: column;
    padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
  }

  /* ========== HEADER ========== */
  .header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 12px 20px;
    flex-shrink: 0;
  }

  .header-brand {
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .header-logo {
    width: 40px;
    height: 40px;
    background: linear-gradient(135deg, var(--accent-gold), var(--accent-gold-dim));
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 800;
    font-size: 18px;
    color: var(--bg-primary);
  }

  .header-title {
    font-size: 22px;
    font-weight: 700;
    color: var(--text-primary);
  }

  .header-subtitle {
    font-size: 12px;
    color: var(--text-dim);
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 1px;
  }

  .header-actions {
    display: flex;
    gap: 8px;
    align-items: center;
  }

  .btn-icon {
    width: 44px;
    height: 44px;
    border-radius: 12px;
    border: 1px solid var(--border-subtle);
    background: var(--bg-secondary);
    color: var(--text-secondary);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 20px;
    cursor: pointer;
    transition: background 0.15s;
  }

  .btn-icon:active {
    background: var(--bg-tile-hover);
  }

  .btn-icon.active {
    background: var(--accent-gold);
    color: var(--bg-primary);
    border-color: var(--accent-gold);
  }

  /* ========== MAIN CONTENT ========== */
  .main {
    flex: 1;
    overflow: hidden;
    padding: 0 16px 16px;
    display: flex;
    flex-direction: column;
  }

  /* ========== BOARD VIEW ========== */
  .board {
    flex: 1;
    display: grid;
    gap: var(--tile-gap);
    padding: 4px;
    align-content: stretch;
  }

  .board.home-board {
    grid-template-columns: repeat(4, 1fr);
    grid-template-rows: repeat(3, 1fr);
  }

  .board.sub-board {
    grid-template-columns: repeat(4, 1fr);
    grid-template-rows: auto repeat(2, 1fr);
  }

  /* ========== TILES ========== */
  .tile {
    background: var(--bg-tile);
    border-radius: var(--radius);
    border: 1px solid var(--border-subtle);
    box-shadow: var(--shadow-tile);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 8px;
    padding: 16px 12px;
    cursor: pointer;
    transition: transform 0.1s, background 0.1s, box-shadow 0.1s;
    position: relative;
    overflow: hidden;
    min-height: 0;
  }

  .tile:active {
    transform: scale(0.97);
    background: var(--bg-tile-active);
    box-shadow: var(--shadow-tile-active);
  }

  .tile-icon {
    font-size: 36px;
    line-height: 1;
    flex-shrink: 0;
  }

  .tile-label {
    font-size: 17px;
    font-weight: 700;
    text-align: center;
    line-height: 1.2;
    color: var(--text-primary);
  }

  .tile-sublabel {
    font-size: 12px;
    color: var(--text-dim);
    font-weight: 600;
  }

  /* Tile variants */
  .tile.urgent {
    background: var(--accent-red-bg);
    border-color: rgba(231, 76, 76, 0.3);
  }

  .tile.urgent .tile-label {
    color: var(--accent-red);
  }

  .tile.confirm-yes {
    background: var(--accent-green-bg);
    border-color: rgba(74, 222, 128, 0.2);
  }

  .tile.confirm-yes .tile-label {
    color: var(--accent-green);
  }

  .tile.category {
    border-color: rgba(240, 168, 48, 0.15);
  }

  .tile.category .tile-label {
    color: var(--accent-gold);
  }

  .tile.action {
    background: var(--bg-secondary);
  }

  /* Category indicator */
  .tile.category::after {
    content: '‚Ä∫';
    position: absolute;
    right: 14px;
    top: 50%;
    transform: translateY(-50%);
    font-size: 24px;
    color: var(--text-dim);
    font-weight: 300;
  }

  /* ========== SUB-BOARD BACK BUTTON ========== */
  .sub-header {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 8px 0;
    grid-column: 1 / -1;
  }

  .btn-back {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 12px 20px;
    background: var(--bg-secondary);
    border: 1px solid var(--border-subtle);
    border-radius: 12px;
    color: var(--text-secondary);
    font-size: 16px;
    font-weight: 600;
    font-family: inherit;
    cursor: pointer;
    transition: background 0.15s;
  }

  .btn-back:active {
    background: var(--bg-tile-hover);
  }

  .sub-title {
    font-size: 20px;
    font-weight: 700;
    color: var(--accent-gold);
  }

  /* ========== COMPOSE VIEW ========== */
  .compose-view {
    flex: 1;
    display: none;
    flex-direction: column;
    gap: 12px;
  }

  .compose-view.active {
    display: flex;
  }

  .compose-output {
    background: var(--bg-secondary);
    border: 1px solid var(--border-subtle);
    border-radius: var(--radius);
    padding: 20px;
    min-height: 100px;
    font-size: 24px;
    font-weight: 600;
    font-family: inherit;
    color: var(--text-primary);
    line-height: 1.4;
    display: flex;
    align-items: flex-start;
    position: relative;
  }

  .compose-text {
    flex: 1;
    min-height: 60px;
    word-wrap: break-word;
    overflow-wrap: break-word;
  }

  .compose-cursor {
    display: inline-block;
    width: 3px;
    height: 28px;
    background: var(--accent-gold);
    animation: blink 1s step-end infinite;
    vertical-align: text-bottom;
    margin-left: 2px;
  }

  @keyframes blink {
    50% { opacity: 0; }
  }

  .compose-actions {
    display: flex;
    gap: 10px;
    flex-shrink: 0;
  }

  .compose-btn {
    flex: 1;
    padding: 18px;
    border-radius: 14px;
    border: 1px solid var(--border-subtle);
    font-size: 18px;
    font-weight: 700;
    font-family: inherit;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    transition: transform 0.1s, background 0.1s;
  }

  .compose-btn:active {
    transform: scale(0.97);
  }

  .compose-btn.speak {
    background: var(--accent-gold);
    color: var(--bg-primary);
    border-color: var(--accent-gold);
  }

  .compose-btn.clear {
    background: var(--bg-tile);
    color: var(--text-secondary);
  }

  .compose-btn.back {
    background: var(--bg-secondary);
    color: var(--text-secondary);
    flex: 0.5;
  }

  .compose-btn.backspace {
    background: var(--bg-tile);
    color: var(--text-secondary);
    flex: 0.5;
  }

  .quick-phrases {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 8px;
    flex-shrink: 0;
  }

  .quick-phrase {
    padding: 14px 10px;
    background: var(--bg-tile);
    border: 1px solid var(--border-subtle);
    border-radius: 12px;
    font-size: 14px;
    font-weight: 600;
    font-family: inherit;
    color: var(--text-primary);
    text-align: center;
    cursor: pointer;
    transition: background 0.15s;
  }

  .quick-phrase:active {
    background: var(--bg-tile-active);
  }

  .compose-keyboard {
    display: grid;
    grid-template-columns: repeat(10, 1fr);
    gap: 6px;
    flex: 1;
    align-content: center;
  }

  .key {
    padding: 14px 4px;
    background: var(--bg-tile);
    border: 1px solid var(--border-subtle);
    border-radius: 10px;
    font-size: 20px;
    font-weight: 600;
    font-family: inherit;
    color: var(--text-primary);
    text-align: center;
    cursor: pointer;
    transition: background 0.1s;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .key:active {
    background: var(--bg-tile-active);
  }

  .key.space {
    grid-column: span 4;
    font-size: 14px;
    color: var(--text-dim);
  }

  .key.wide {
    grid-column: span 2;
  }

  /* ========== SPEAKING INDICATOR ========== */
  .speaking-indicator {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: var(--accent-gold);
    transform: scaleX(0);
    transform-origin: left;
    transition: transform 0.3s;
    z-index: 100;
  }

  .speaking-indicator.active {
    transform: scaleX(1);
    animation: speakPulse 1.5s ease-in-out infinite;
  }

  @keyframes speakPulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
  }

  /* ========== LAST SPOKEN BANNER ========== */
  .last-spoken {
    position: fixed;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%) translateY(80px);
    background: rgba(30, 45, 68, 0.95);
    backdrop-filter: blur(10px);
    border: 1px solid var(--border-subtle);
    border-radius: 14px;
    padding: 14px 24px;
    font-size: 16px;
    font-weight: 600;
    color: var(--text-secondary);
    display: flex;
    align-items: center;
    gap: 10px;
    transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1);
    z-index: 50;
    max-width: 80%;
  }

  .last-spoken.visible {
    transform: translateX(-50%) translateY(0);
  }

  .last-spoken-icon {
    color: var(--accent-gold);
    font-size: 18px;
    flex-shrink: 0;
  }

  .btn-repeat {
    padding: 8px 14px;
    background: var(--bg-tile);
    border: 1px solid var(--border-subtle);
    border-radius: 8px;
    color: var(--accent-gold);
    font-size: 13px;
    font-weight: 700;
    font-family: inherit;
    cursor: pointer;
    flex-shrink: 0;
    transition: background 0.15s;
  }

  .btn-repeat:active {
    background: var(--bg-tile-active);
  }

  /* ========== VOLUME SLIDER (SETTINGS) ========== */
  .settings-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.6);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 200;
  }

  .settings-overlay.active {
    display: flex;
  }

  .settings-panel {
    background: var(--bg-secondary);
    border-radius: 20px;
    padding: 30px;
    width: 500px;
    max-width: 90vw;
    max-height: 80vh;
    overflow-y: auto;
    border: 1px solid var(--border-subtle);
  }

  .settings-title {
    font-size: 22px;
    font-weight: 700;
    margin-bottom: 24px;
    display: flex;
    align-items: center;
    justify-content: space-between;
  }

  .settings-close {
    width: 40px;
    height: 40px;
    border-radius: 10px;
    border: 1px solid var(--border-subtle);
    background: var(--bg-tile);
    color: var(--text-secondary);
    font-size: 20px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .setting-row {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 16px 0;
    border-bottom: 1px solid var(--border-subtle);
  }

  .setting-label {
    font-size: 16px;
    font-weight: 600;
  }

  .setting-desc {
    font-size: 13px;
    color: var(--text-dim);
    margin-top: 2px;
  }

  .setting-control {
    display: flex;
    align-items: center;
    gap: 10px;
  }

  input[type="range"] {
    -webkit-appearance: none;
    width: 150px;
    height: 8px;
    background: var(--bg-tile);
    border-radius: 4px;
    outline: none;
  }

  input[type="range"]::-webkit-slider-thumb {
    -webkit-appearance: none;
    width: 28px;
    height: 28px;
    background: var(--accent-gold);
    border-radius: 50%;
    cursor: pointer;
  }

  select {
    padding: 10px 14px;
    background: var(--bg-tile);
    border: 1px solid var(--border-subtle);
    border-radius: 8px;
    color: var(--text-primary);
    font-size: 14px;
    font-family: inherit;
    font-weight: 600;
    cursor: pointer;
    -webkit-appearance: none;
    padding-right: 30px;
  }

  /* ========== CAREGIVER ALERT ========== */
  .alert-flash {
    position: fixed;
    inset: 0;
    background: rgba(231, 76, 76, 0.15);
    z-index: 300;
    pointer-events: none;
    opacity: 0;
    transition: opacity 0.2s;
  }

  .alert-flash.active {
    opacity: 1;
    animation: alertPulse 0.6s ease-in-out 3;
  }

  @keyframes alertPulse {
    0%, 100% { opacity: 0; }
    50% { opacity: 1; }
  }

  /* ========== TRANSITIONS ========== */
  .board {
    transition: opacity 0.2s, transform 0.2s;
  }

  .board.hidden {
    display: none;
  }

  /* ========== RESPONSIVE ========== */
  @media (max-height: 600px) {
    .tile-icon { font-size: 28px; }
    .tile-label { font-size: 15px; }
    .header { padding: 8px 16px; }
    .tile { padding: 10px 8px; gap: 4px; }
  }

  @media (orientation: portrait) {
    .board.home-board {
      grid-template-columns: repeat(3, 1fr);
      grid-template-rows: repeat(4, 1fr);
    }
    .board.sub-board {
      grid-template-columns: repeat(3, 1fr);
    }
    .quick-phrases {
      grid-template-columns: repeat(3, 1fr);
    }
  }
</style>
</head>
<body>

<!-- Speaking indicator bar -->
<div class="speaking-indicator" id="speakingIndicator"></div>

<!-- Alert flash overlay -->
<div class="alert-flash" id="alertFlash"></div>

<!-- ===== HEADER ===== -->
<header class="header">
  <div class="header-brand">
    <div class="header-logo">A</div>
    <div>
      <div class="header-title">Big Al</div>
      <div class="header-subtitle">Alex's Voice</div>
    </div>
  </div>
  <div class="header-actions">
    <button class="btn-icon" id="btnRepeatLast" title="Repeat last" aria-label="Repeat last phrase">üîÅ</button>
    <button class="btn-icon" id="btnVolumeUp" title="Louder" aria-label="Increase volume">üîä</button>
    <button class="btn-icon" id="btnSettings" title="Settings" aria-label="Settings">‚öôÔ∏è</button>
  </div>
</header>

<!-- ===== MAIN CONTENT ===== -->
<main class="main">
  <!-- Home Board -->
  <div class="board home-board" id="homeBoard"></div>

  <!-- Sub Board (categories) -->
  <div class="board sub-board hidden" id="subBoard"></div>

  <!-- Compose View -->
  <div class="compose-view" id="composeView">
    <div class="compose-output">
      <div class="compose-text" id="composeText"></div>
      <div class="compose-cursor"></div>
    </div>
    <div class="compose-actions">
      <button class="compose-btn back" id="composeBack">‚Üê Back</button>
      <button class="compose-btn backspace" id="composeBackspace">‚å´ Delete</button>
      <button class="compose-btn clear" id="composeClear">Clear</button>
      <button class="compose-btn speak" id="composeSpeak">üîä Speak</button>
    </div>
    <div class="quick-phrases" id="quickPhrases"></div>
    <div class="compose-keyboard" id="composeKeyboard"></div>
  </div>
</main>

<!-- Last spoken banner -->
<div class="last-spoken" id="lastSpoken">
  <span class="last-spoken-icon">üîä</span>
  <span id="lastSpokenText"></span>
  <button class="btn-repeat" id="btnRepeatBanner">Repeat</button>
</div>

<!-- Settings overlay -->
<div class="settings-overlay" id="settingsOverlay">
  <div class="settings-panel">
    <div class="settings-title">
      Settings
      <button class="settings-close" id="settingsClose">‚úï</button>
    </div>

    <div class="setting-row">
      <div>
        <div class="setting-label">Voice</div>
        <div class="setting-desc">Choose the speaking voice</div>
      </div>
      <div class="setting-control">
        <select id="voiceSelect"></select>
      </div>
    </div>

    <div class="setting-row">
      <div>
        <div class="setting-label">Speech Speed</div>
        <div class="setting-desc">How fast the voice speaks</div>
      </div>
      <div class="setting-control">
        <span id="rateValue">1.0</span>
        <input type="range" id="rateSlider" min="0.5" max="1.5" step="0.1" value="1.0">
      </div>
    </div>

    <div class="setting-row">
      <div>
        <div class="setting-label">Pitch</div>
        <div class="setting-desc">Voice pitch level</div>
      </div>
      <div class="setting-control">
        <span id="pitchValue">1.0</span>
        <input type="range" id="pitchSlider" min="0.5" max="1.5" step="0.1" value="1.0">
      </div>
    </div>

    <div class="setting-row">
      <div>
        <div class="setting-label">Volume</div>
        <div class="setting-desc">Speaker volume</div>
      </div>
      <div class="setting-control">
        <span id="volumeValue">100%</span>
        <input type="range" id="volumeSlider" min="0.3" max="1" step="0.1" value="1">
      </div>
    </div>

    <div class="setting-row" style="border: none; padding-top: 20px;">
      <div>
        <div class="setting-label" style="color: var(--text-dim);">Big Al v1.0</div>
        <div class="setting-desc">Made with love for Alex</div>
      </div>
    </div>
  </div>
</div>

<script>
// ============================================================
// BIG AL ‚Äî Configuration & Core Logic
// ============================================================

// --- BOARD CONFIGURATION ---
// This is the central config. Caregivers can edit phrases here.
const CONFIG = {
  // Home board tiles (max ~12 for landscape 4-col layout)
  home: [
    { id: 'urgent', label: 'I Need Help', icon: 'üö®', type: 'urgent', phrase: 'I need help right now', alert: true },
    { id: 'needs', label: 'My Needs', icon: 'üôã', type: 'category' },
    { id: 'feelings', label: 'How I Feel', icon: 'üí≠', type: 'category' },
    { id: 'social', label: 'Social', icon: 'üí¨', type: 'category' },
    { id: 'yes', label: 'Yes', icon: '‚úÖ', type: 'confirm-yes', phrase: 'Yes' },
    { id: 'no', label: 'No', icon: '‚ùå', type: 'phrase', phrase: 'No' },
    { id: 'thanks', label: 'Thank You', icon: 'üôè', type: 'phrase', phrase: 'Thank you' },
    { id: 'repeat', label: 'Say Again?', icon: 'üîÑ', type: 'phrase', phrase: 'Can you say that again please?' },
    { id: 'compose', label: 'Type Message', icon: '‚å®Ô∏è', type: 'action', action: 'compose' },
    { id: 'wait', label: 'Hold On', icon: '‚úã', type: 'phrase', phrase: 'Hold on, give me a moment' },
    { id: 'tv', label: 'TV / Music', icon: 'üì∫', type: 'category' },
    { id: 'mom', label: 'Call Mom', icon: 'üìû', type: 'phrase', phrase: 'Can someone call Mom for me?' },
  ],

  // Category sub-boards
  categories: {
    needs: {
      title: 'My Needs',
      tiles: [
        { label: 'I Want to Stand', icon: 'üßç', phrase: 'I want to stand up please' },
        { label: 'Standing Frame', icon: 'üèãÔ∏è', phrase: 'I want to use my standing frame' },
        { label: 'Bathroom', icon: 'üöª', phrase: 'I need to go to the bathroom' },
        { label: 'Suction Machine', icon: 'üí®', phrase: 'I need the suction machine' },
        { label: 'Eye Drops', icon: 'üíß', phrase: 'I need my drops' },
        { label: 'Water / Drink', icon: 'ü•§', phrase: 'Can I have something to drink?' },
        { label: 'Food', icon: 'üçΩÔ∏è', phrase: 'I\'m hungry' },
        { label: 'Too Hot', icon: 'ü•µ', phrase: 'I\'m too hot, can you adjust the temperature?' },
        { label: 'Too Cold', icon: 'ü•∂', phrase: 'I\'m too cold' },
        { label: 'Reposition Me', icon: 'üîÑ', phrase: 'Can you help reposition me?' },
        { label: 'Blanket', icon: 'üõèÔ∏è', phrase: 'Can I have a blanket?' },
        { label: 'Medication', icon: 'üíä', phrase: 'I need my medication' },
      ]
    },
    feelings: {
      title: 'How I Feel',
      tiles: [
        { label: 'I\'m Good', icon: 'üòä', phrase: 'I\'m doing good' },
        { label: 'I\'m Tired', icon: 'üò¥', phrase: 'I\'m feeling tired' },
        { label: 'In Pain', icon: 'üò£', phrase: 'I\'m in pain', urgent: true },
        { label: 'Frustrated', icon: 'üò§', phrase: 'I\'m feeling frustrated' },
        { label: 'Bored', icon: 'üòê', phrase: 'I\'m bored' },
        { label: 'Happy', icon: 'üòÑ', phrase: 'I\'m feeling happy' },
        { label: 'Anxious', icon: 'üò∞', phrase: 'I\'m feeling anxious' },
        { label: 'Love You', icon: '‚ù§Ô∏è', phrase: 'I love you' },
      ]
    },
    social: {
      title: 'Social',
      tiles: [
        { label: 'Hey!', icon: 'üëã', phrase: 'Hey, how\'s it going?' },
        { label: 'That\'s Funny', icon: 'üòÇ', phrase: 'Ha ha, that\'s funny' },
        { label: 'Good Morning', icon: 'üåÖ', phrase: 'Good morning' },
        { label: 'Good Night', icon: 'üåô', phrase: 'Good night, sleep well' },
        { label: 'Miss You', icon: 'üíô', phrase: 'I miss you' },
        { label: 'What\'s New?', icon: 'üì∞', phrase: 'What\'s new with you?' },
        { label: 'Tell Me More', icon: 'üëÇ', phrase: 'Tell me more about that' },
        { label: 'Nice!', icon: 'üëç', phrase: 'That\'s awesome!' },
      ]
    },
    tv: {
      title: 'TV / Music',
      tiles: [
        { label: 'Turn On TV', icon: 'üì∫', phrase: 'Can you turn on the TV?' },
        { label: 'Change Channel', icon: 'üîÑ', phrase: 'Can you change the channel?' },
        { label: 'Volume Up', icon: 'üîä', phrase: 'Can you turn it up?' },
        { label: 'Volume Down', icon: 'üîâ', phrase: 'Can you turn it down?' },
        { label: 'Play Music', icon: 'üéµ', phrase: 'Can you put some music on?' },
        { label: 'Turn It Off', icon: '‚èπÔ∏è', phrase: 'Can you turn that off?' },
      ]
    }
  },

  // Quick phrases for compose mode
  quickPhrases: [
    'I want to',
    'Can you',
    'Please',
    'Tell',
    'I need',
    'Thank you',
    'Where is',
    'When',
  ],

  // Voice settings (persisted to localStorage)
  voice: {
    rate: 1.0,
    pitch: 1.0,
    volume: 1.0,
    voiceURI: null, // null = auto-select best male voice
  }
};

// ============================================================
// STATE
// ============================================================
let state = {
  currentView: 'home', // 'home', 'category', 'compose'
  currentCategory: null,
  composeText: '',
  lastSpokenPhrase: '',
  isSpeaking: false,
};

// ============================================================
// SPEECH ENGINE
// ============================================================
const synth = window.speechSynthesis;
let voices = [];
let selectedVoice = null;

function loadVoices() {
  voices = synth.getVoices();
  populateVoiceSelect();
  selectBestVoice();
}

function selectBestVoice() {
  const savedURI = loadSetting('voiceURI');
  if (savedURI) {
    selectedVoice = voices.find(v => v.voiceURI === savedURI) || null;
  }
  if (!selectedVoice) {
    // Prefer enhanced/premium English male voices
    const prefs = [
      v => v.lang.startsWith('en') && v.name.toLowerCase().includes('daniel'),
      v => v.lang.startsWith('en') && v.name.toLowerCase().includes('aaron'),
      v => v.lang.startsWith('en') && v.name.toLowerCase().includes('james'),
      v => v.lang.startsWith('en') && (v.name.toLowerCase().includes('enhanced') || v.name.toLowerCase().includes('premium')),
      v => v.lang.startsWith('en-US'),
      v => v.lang.startsWith('en'),
    ];
    for (const pref of prefs) {
      selectedVoice = voices.find(pref);
      if (selectedVoice) break;
    }
  }
  // Update select
  const sel = document.getElementById('voiceSelect');
  if (sel && selectedVoice) {
    sel.value = selectedVoice.voiceURI;
  }
}

function speak(text, urgent = false) {
  if (!text) return;
  synth.cancel(); // Stop any current speech

  const utter = new SpeechSynthesisUtterance(text);
  if (selectedVoice) utter.voice = selectedVoice;
  utter.rate = parseFloat(loadSetting('rate') || CONFIG.voice.rate);
  utter.pitch = parseFloat(loadSetting('pitch') || CONFIG.voice.pitch);
  utter.volume = urgent ? 1.0 : parseFloat(loadSetting('volume') || CONFIG.voice.volume);

  utter.onstart = () => {
    state.isSpeaking = true;
    document.getElementById('speakingIndicator').classList.add('active');
  };
  utter.onend = () => {
    state.isSpeaking = false;
    document.getElementById('speakingIndicator').classList.remove('active');
  };
  utter.onerror = () => {
    state.isSpeaking = false;
    document.getElementById('speakingIndicator').classList.remove('active');
  };

  synth.speak(utter);
  state.lastSpokenPhrase = text;
  showLastSpoken(text);
}

// ============================================================
// BOARD RENDERING
// ============================================================
function renderHomeBoard() {
  const board = document.getElementById('homeBoard');
  board.innerHTML = '';
  board.classList.remove('hidden');
  document.getElementById('subBoard').classList.add('hidden');
  document.getElementById('composeView').classList.remove('active');
  state.currentView = 'home';

  CONFIG.home.forEach(tile => {
    const el = createTileElement(tile);
    board.appendChild(el);
  });
}

function renderSubBoard(categoryId) {
  const cat = CONFIG.categories[categoryId];
  if (!cat) return;

  const home = document.getElementById('homeBoard');
  const sub = document.getElementById('subBoard');
  home.classList.add('hidden');
  document.getElementById('composeView').classList.remove('active');
  sub.classList.remove('hidden');
  sub.innerHTML = '';
  state.currentView = 'category';
  state.currentCategory = categoryId;

  // Back button row
  const header = document.createElement('div');
  header.className = 'sub-header';
  header.innerHTML = `
    <button class="btn-back" id="subBackBtn">‚Üê Back</button>
    <span class="sub-title">${cat.title}</span>
  `;
  sub.appendChild(header);
  header.querySelector('#subBackBtn').addEventListener('click', renderHomeBoard);

  cat.tiles.forEach(tile => {
    const el = createTileElement({ ...tile, type: tile.urgent ? 'urgent' : 'phrase' });
    sub.appendChild(el);
  });
}

function createTileElement(tile) {
  const el = document.createElement('div');
  el.className = `tile ${tile.type || ''}`;
  el.innerHTML = `
    <span class="tile-icon">${tile.icon || ''}</span>
    <span class="tile-label">${tile.label}</span>
  `;

  el.addEventListener('click', () => {
    if (tile.type === 'category') {
      renderSubBoard(tile.id);
    } else if (tile.action === 'compose') {
      showCompose();
    } else if (tile.phrase) {
      speak(tile.phrase, tile.alert || tile.urgent);
      if (tile.alert) {
        triggerAlert();
      }
    }
  });

  return el;
}

// ============================================================
// COMPOSE VIEW
// ============================================================
function showCompose() {
  document.getElementById('homeBoard').classList.add('hidden');
  document.getElementById('subBoard').classList.add('hidden');
  document.getElementById('composeView').classList.add('active');
  state.currentView = 'compose';
  state.composeText = '';
  updateComposeDisplay();
  renderQuickPhrases();
  renderKeyboard();
}

function updateComposeDisplay() {
  document.getElementById('composeText').textContent = state.composeText;
}

function renderQuickPhrases() {
  const container = document.getElementById('quickPhrases');
  container.innerHTML = '';
  CONFIG.quickPhrases.forEach(phrase => {
    const btn = document.createElement('button');
    btn.className = 'quick-phrase';
    btn.textContent = phrase;
    btn.addEventListener('click', () => {
      state.composeText += (state.composeText && !state.composeText.endsWith(' ') ? ' ' : '') + phrase + ' ';
      updateComposeDisplay();
    });
    container.appendChild(btn);
  });
}

function renderKeyboard() {
  const container = document.getElementById('composeKeyboard');
  container.innerHTML = '';

  const rows = [
    ['Q','W','E','R','T','Y','U','I','O','P'],
    ['A','S','D','F','G','H','J','K','L','\''],
    ['Z','X','C','V',' ','B','N','M','.',','],
  ];

  rows.forEach(row => {
    row.forEach(key => {
      const btn = document.createElement('button');
      btn.className = 'key' + (key === ' ' ? ' space' : '');
      btn.textContent = key === ' ' ? 'SPACE' : key;
      btn.addEventListener('click', () => {
        state.composeText += key === ' ' ? ' ' : key;
        updateComposeDisplay();
      });
      container.appendChild(btn);
    });
  });
}

// Compose action buttons
document.getElementById('composeBack').addEventListener('click', renderHomeBoard);
document.getElementById('composeClear').addEventListener('click', () => {
  state.composeText = '';
  updateComposeDisplay();
});
document.getElementById('composeBackspace').addEventListener('click', () => {
  state.composeText = state.composeText.slice(0, -1);
  updateComposeDisplay();
});
document.getElementById('composeSpeak').addEventListener('click', () => {
  if (state.composeText.trim()) {
    speak(state.composeText.trim());
  }
});

// ============================================================
// LAST SPOKEN / REPEAT
// ============================================================
let lastSpokenTimeout;

function showLastSpoken(text) {
  const el = document.getElementById('lastSpoken');
  document.getElementById('lastSpokenText').textContent = text;
  el.classList.add('visible');
  clearTimeout(lastSpokenTimeout);
  lastSpokenTimeout = setTimeout(() => {
    el.classList.remove('visible');
  }, 6000);
}

document.getElementById('btnRepeatLast').addEventListener('click', () => {
  if (state.lastSpokenPhrase) speak(state.lastSpokenPhrase);
});
document.getElementById('btnRepeatBanner').addEventListener('click', () => {
  if (state.lastSpokenPhrase) speak(state.lastSpokenPhrase);
});

// ============================================================
// VOLUME QUICK BUTTON
// ============================================================
document.getElementById('btnVolumeUp').addEventListener('click', () => {
  const current = parseFloat(loadSetting('volume') || 1);
  const next = current >= 1 ? 0.5 : 1.0;
  saveSetting('volume', next);
  document.getElementById('volumeSlider').value = next;
  document.getElementById('volumeValue').textContent = Math.round(next * 100) + '%';
  speak(next >= 1 ? 'Volume full' : 'Volume reduced');
});

// ============================================================
// ALERT SYSTEM
// ============================================================
function triggerAlert() {
  const flash = document.getElementById('alertFlash');
  flash.classList.add('active');
  setTimeout(() => flash.classList.remove('active'), 2000);
  // If Notification API is available, send a push
  if ('Notification' in window && Notification.permission === 'granted') {
    new Notification('Big Al ‚Äî Alex Needs Help', {
      body: 'Alex pressed the emergency button',
      icon: 'üö®',
      requireInteraction: true,
    });
  }
}

// Request notification permission on first load
if ('Notification' in window && Notification.permission === 'default') {
  // We'll request on first urgent press instead of on load
  const origTrigger = triggerAlert;
  // Actually let's just try on load ‚Äî iPad may not support this well
  // but it doesn't hurt to try
  Notification.requestPermission();
}

// ============================================================
// SETTINGS
// ============================================================
document.getElementById('btnSettings').addEventListener('click', () => {
  document.getElementById('settingsOverlay').classList.add('active');
});
document.getElementById('settingsClose').addEventListener('click', () => {
  document.getElementById('settingsOverlay').classList.remove('active');
});
document.getElementById('settingsOverlay').addEventListener('click', (e) => {
  if (e.target === document.getElementById('settingsOverlay')) {
    document.getElementById('settingsOverlay').classList.remove('active');
  }
});

// Voice select
function populateVoiceSelect() {
  const sel = document.getElementById('voiceSelect');
  sel.innerHTML = '';
  const englishVoices = voices.filter(v => v.lang.startsWith('en'));
  englishVoices.forEach(v => {
    const opt = document.createElement('option');
    opt.value = v.voiceURI;
    opt.textContent = v.name.replace('com.apple.', '').replace('speech.synthesis.voice.', '');
    sel.appendChild(opt);
  });
}

document.getElementById('voiceSelect').addEventListener('change', (e) => {
  selectedVoice = voices.find(v => v.voiceURI === e.target.value);
  saveSetting('voiceURI', e.target.value);
  speak('This is how I sound');
});

document.getElementById('rateSlider').addEventListener('input', (e) => {
  document.getElementById('rateValue').textContent = e.target.value;
  saveSetting('rate', e.target.value);
});
document.getElementById('rateSlider').addEventListener('change', () => {
  speak('Testing speech speed');
});

document.getElementById('pitchSlider').addEventListener('input', (e) => {
  document.getElementById('pitchValue').textContent = e.target.value;
  saveSetting('pitch', e.target.value);
});
document.getElementById('pitchSlider').addEventListener('change', () => {
  speak('Testing voice pitch');
});

document.getElementById('volumeSlider').addEventListener('input', (e) => {
  document.getElementById('volumeValue').textContent = Math.round(e.target.value * 100) + '%';
  saveSetting('volume', e.target.value);
});

// ============================================================
// LOCAL STORAGE HELPERS
// ============================================================
function saveSetting(key, value) {
  try { localStorage.setItem('bigal_' + key, JSON.stringify(value)); } catch(e) {}
}

function loadSetting(key) {
  try {
    const v = localStorage.getItem('bigal_' + key);
    return v ? JSON.parse(v) : null;
  } catch(e) { return null; }
}

function restoreSettings() {
  const rate = loadSetting('rate');
  const pitch = loadSetting('pitch');
  const vol = loadSetting('volume');
  if (rate) { document.getElementById('rateSlider').value = rate; document.getElementById('rateValue').textContent = rate; }
  if (pitch) { document.getElementById('pitchSlider').value = pitch; document.getElementById('pitchValue').textContent = pitch; }
  if (vol) { document.getElementById('volumeSlider').value = vol; document.getElementById('volumeValue').textContent = Math.round(vol * 100) + '%'; }
}

// ============================================================
// INIT
// ============================================================
function init() {
  // Load voices
  if (synth.onvoiceschanged !== undefined) {
    synth.onvoiceschanged = loadVoices;
  }
  loadVoices();
  restoreSettings();
  renderHomeBoard();
}

init();
</script>
</body>
</html>